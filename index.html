<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Игра Мемори</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="vendor/react.development.js"></script>
  <script src="vendor/react-dom.development.js"></script>
  <script src="vendor/babel.min.js"></script>
  <script src="vendor/get-declension.min.umd.js"></script>
  <script src="data.js"></script>
  <script src="settings.js"></script>
</head>
<body>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <div id="root"></div>
  <script type="text/babel">
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App getImages={getImages} results={results}/>);

    const useGame = (images) => {
      const [stepsCount, setStepsCount] = React.useState(0);
      const [finishedCards, setFinishedCards] = React.useState([]);
      const isWin = finishedCards.length === images.length;

      const checkCards = (firstId, secondId) => {
        const firstCard = images.find((image) => image.id === firstId);
        const secondCard = images.find((image) => image.id === secondId);
        
        if (firstCard.url === secondCard.url) {
          setFinishedCards((cards) => [...cards, firstId, secondId]);
        };

        setStepsCount((step) => step + 1);
      }

      return {
        stepsCount,
        finishedCards,
        checkCards,
        isWin,
      }
    }

    function App({GetImages, results = []}) {
      const [page, setPage] = React.useState(AppRoute.Initial);
      const [theme, setTheme] = React.useState(null);
      const [images, setImages] = React.useState([]);
      const [result, setResult] = React.useState(0);

      const handleGameStart = (theme) => {
        setTheme(theme);
        setImages(getImages(theme));
        setPage(AppRoute.Game);
      }

      const getPage = (page) => {
        switch (page) {
          case AppRoute.Initial:
            return (
              <InitialPage onGameStart={handleGameStart} />
            );
          case AppRoute.Game:
            return (
              <GamePage 
                theme={theme} 
                images={images} 
                setResult={setResult} 
                setPage={setPage} 
              />
            );
          case AppRoute.Results:
            return (
              <ResultsPage 
                result={result} 
                setPage={setPage} 
                results={results}
              />
            );
          default:
            return null;
        }
      }

      return getPage(page);
    }

    function InitialPage({onGameStart}) {
      return (
        <section className="rules container">
          <h2>Добро пожаловать!</h2>
          <p>Memory — игра для тренировки визуальной памяти</p>
          <div className="rules-panel">
            <h3>Правила игры</h3>
            <ul className="rules-list">
              <li>В наборе есть множество карточек – по две штуки с одним и тем же рисунком.</li>
              <li>Нужно разложить карточки «рубашкой» вверх на столе, а затем переворачивать по две.</li>
              <li>Если они совпадают – игрок забирает их и получает ещё один ход.</li>
            </ul>
          </div>
          <button onClick={() => onGameStart(AppTheme.Cats)}
            className={`ico-button ico-button-${AppTheme.Cats}`} type="button">Котики</button>
          <button onClick={() => onGameStart(AppTheme.Flowers)}
            className={`ico-button ico-button-${AppTheme.Flowers}`} type="button">Цветочки</button>
          <button onClick={() => onGameStart(AppTheme.Cars)}
            className={`ico-button ico-button-${AppTheme.Cars}`} type="button">Машины</button>
        </section>
      );
    }

    function GamePage({theme, images = [], setResult, setPage}) {
      const {
        stepsCount,
        finishedCards,
        checkCards,
        isWin,
      } = useGame(images);

      const handleResultsClick = () => {
        setResult(stepsCount);
        setPage(AppRoute.Results);
      };

      return (
        <>
          <section className="game container">
            <Progress 
              finishedPairsAmount={finishedCards.length / 2} 
              pairsAmount={images.length / 2}
            />
            <div className="steps">Шаг {stepsCount}</div>
            <CardsList 
              theme={theme}
              images={images} 
              finishedCards={finishedCards}
              checkCards={checkCards} 
            />
          </section>
          {isWin && 
            (<Modal>
              <h3 className="modal-caption">Победа!</h3>
              <p className="modal-description">Теперь давайте узнаем результаты этой партии</p>
              <button className="button modal-button" type="button" onClick={handleResultsClick}>Показать результаты</button>
            </Modal>)}
        </>
      )
    }

    function Progress({finishedPairsAmount, pairsAmount}) {
      return (
        <>
          <div className="progress-wrapper">
            <div className="progress" style={{width: `${finishedPairsAmount / pairsAmount * 100}%`}}></div>
          </div>
          <p className="progress-description">Открыто <span>{finishedPairsAmount}</span> / <span>{pairsAmount}</span></p>
        </>
      )
    }

    function CardsList({theme, images, finishedCards, checkCards}) {
      const [visibleCards, setVisibleCards] = React.useState([]);

      const handleCardClick = (id) => {
        if (visibleCards.includes(id) || finishedCards.includes(id)) {
          return;
        }

        switch (visibleCards.length) {
          case 0: 
            setVisibleCards([id]);
            break;
            case 1:
              setVisibleCards((cards) => [...cards, id]);
              checkCards(...visibleCards, id);
              setTimeout(() => {
                setVisibleCards([]);
              }, TIMEOUT);
              break;
          default: 
            setVisibleCards([]);
        }
      }
      
      return (
        <ul className={`cards cards-theme-${theme}`}>
          {images.map(image => 
            <Card 
              key={image.id} 
              id={image.id}
              url={image.url} 
              description={image.description} 
              isVisible={visibleCards.includes(image.id)} 
              isFinished={finishedCards.includes(image.id)}
              onCardClick={handleCardClick}
            />)}
        </ul>
      )
    }

    function Card({id, url, description, isVisible, isFinished, onCardClick}) {
      const className = `card ${isVisible ? 'card-show' : ''} ${isFinished ? 'card-finished' : ''}`;

      const handleClick = () => {
        onCardClick(id);
      }

      return (
        <li 
          className={className}
          onClick={handleClick}
        >
          <img 
            src={url} 
            width="204" height="144" 
            alt={description} 
          />
        </li>
      );
    }

    function Modal({children}) {
      return (
        <div className="modal">
          <div className="modal-box">
            {children}
          </div>
        </div>
      );
    }

    function ResultsPage({result, setPage, results}) {
      const handleResetButtonClick = () => {
        setPage(AppRoute.Initial);
      }

      const sortedResults = [...results, { name: 'Ваш результат', stepsCount: result }].sort((a, b) => a.stepsCount - b.stepsCount);
      const rows = sortedResults.map(({name, stepsCount}, index) => (
        <tr className={`result-table-row ${name === 'Ваш результат' ? 'active' : ''}`}>
          <td>{index}</td>
          <td>{name}</td>
          <td>{stepsCount}</td>
        </tr>
      ))

      const stepsDeclension = getDeclension({count: result, one: 'шаг', few: 'шага', many: 'шагов'});

      return (
        <section className="result container">
          <h2>Лучшие результаты:</h2>
          <p>Вы завершили игру за <b>{stepsDeclension}</b>, так держать!</p>
          <table className="result-table">
            <thead>
            <tr className="result-table-row">
              <th>Место</th>
              <th>Имя</th>
              <th>Шаги</th>
            </tr>
            </thead>
            <tbody>
            {rows}
            </tbody>
          </table>
          <p>Хотите попробовать ещё раз?</p>
          <button className="button result-button" type="button" onClick={handleResetButtonClick}>Новая игра</button>
        </section>
      );
    }
  </script>
</body>
</html>
